/* app.js — Pianeta 3D Lab (compatibile con il tuo index.html)
   - Salvataggio in localStorage
   - Ordini attivi + completati ultime 24h in tabella
   - Board Produzione con colonne e regole accesso in Assemblaggio
   - Vendite protette da password 1234, solo completati ultimi 365 giorni
   - Export Excel Giorno / Mese in CSV (apre in Excel)
*/

(() => {
  // ---------------------------
  // Config
  // ---------------------------
  const LS_KEY = "p3dlab_orders_v1";
  const SALES_UNLOCK_KEY = "p3dlab_sales_unlocked";
  const SALES_PASSWORD = "1234";

  const STATUSES = [
    "Ricevuto",
    "Stampa",
    "Post-Processing",
    "Controllo Qualità",
    "Assemblaggio",
    "Spedizione",
    "Completato",
  ];

  // ---------------------------
  // Helpers
  // ---------------------------
  const now = () => Date.now();

  function pad2(n) { return String(n).padStart(2, "0"); }

  function formatDateTime(ts) {
    const d = new Date(ts);
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function formatDate(ts) {
    const d = new Date(ts);
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  }

  function euro(n) {
    const v = Number(n || 0);
    return v.toLocaleString("it-IT", { style: "currency", currency: "EUR" });
  }

  function uid() {
    return "ord_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function loadOrders() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      const data = raw ? JSON.parse(raw) : [];
      return Array.isArray(data) ? data : [];
    } catch {
      return [];
    }
  }

  function saveOrders(orders) {
    localStorage.setItem(LS_KEY, JSON.stringify(orders));
  }

  function updateOrder(id, patch) {
    const orders = loadOrders();
    const idx = orders.findIndex(o => o.id === id);
    if (idx === -1) return;
    orders[idx] = { ...orders[idx], ...patch, updatedAt: now() };
    saveOrders(orders);
    rerenderAll();
  }

  function withinHours(ts, h) {
    return (now() - ts) <= h * 60 * 60 * 1000;
  }

  function withinDays(ts, d) {
    return (now() - ts) <= d * 24 * 60 * 60 * 1000;
  }

  function sanitizeCsv(v) {
    const s = String(v ?? "");
    // quote if contains comma, quote or newline
    if (/[,"\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }

  function downloadTextFile(filename, text, mime = "text/plain;charset=utf-8") {
    const blob = new Blob([text], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---------------------------
  // Routing / Tabs
  // ---------------------------
  function showNew() {
    document.getElementById("page-new").classList.remove("hide");
    document.getElementById("page-prep").classList.add("hide");
    document.getElementById("page-sales").classList.add("hide");
    refreshActiveTable();
  }

  function showPrep() {
    document.getElementById("page-new").classList.add("hide");
    document.getElementById("page-prep").classList.remove("hide");
    document.getElementById("page-sales").classList.add("hide");
    renderBoard();
  }

  function showSales() {
    document.getElementById("page-new").classList.add("hide");
    document.getElementById("page-prep").classList.add("hide");
    document.getElementById("page-sales").classList.remove("hide");
    refreshSales();
  }

  // Expose to window because index.html calls these
  window.showNew = showNew;
  window.showPrep = showPrep;

  window.openSales = function openSales() {
    const unlocked = localStorage.getItem(SALES_UNLOCK_KEY) === "1";
    if (!unlocked) {
      const pw = prompt("Password Vendite:");
      if (pw !== SALES_PASSWORD) {
        alert("Password errata.");
        return;
      }
      localStorage.setItem(SALES_UNLOCK_KEY, "1");
    }
    setActive("sales");
    showSales();
  };

  window.lockSales = function lockSales() {
    localStorage.removeItem(SALES_UNLOCK_KEY);
    alert("Vendite bloccate.");
    setActive("new");
    showNew();
  };

  // ---------------------------
  // Add Order (Nuovo ordine)
  // ---------------------------
  window.addOrder = function addOrder() {
    const cliente = (document.getElementById("cliente").value || "").trim();
    const sito = (document.getElementById("sito").value || "").trim();
    const progetto = (document.getElementById("progetto").value || "").trim();
    const prezzo = Number(document.getElementById("prezzo").value || 0);
    const note = (document.getElementById("note").value || "").trim();

    if (!progetto) {
      alert("Inserisci Numero progetto (ARTICOLO).");
      return;
    }
    if (!cliente) {
      alert("Inserisci Cliente.");
      return;
    }
    if (!sito) {
      alert("Inserisci Sito vendita.");
      return;
    }

    const ts = now();
    const order = {
      id: uid(),
      articolo: progetto,
      cliente,
      sito,
      prezzo: isFinite(prezzo) ? prezzo : 0,
      note,
      status: "Ricevuto",
      createdAt: ts,
      updatedAt: ts,
      // flags QC
      frontOk: false,
      backOk: false,
    };

    const orders = loadOrders();
    // se stesso articolo esiste ancora attivo, avvisa
    const existsActive = orders.some(o => o.articolo === order.articolo && o.status !== "Completato");
    if (existsActive) {
      const ok = confirm("Esiste già un ordine attivo con lo stesso ARTICOLO. Vuoi inserirlo lo stesso?");
      if (!ok) return;
    }

    orders.unshift(order);
    saveOrders(orders);

    // reset campi
    document.getElementById("cliente").value = "";
    document.getElementById("sito").value = "";
    document.getElementById("progetto").value = "";
    document.getElementById("prezzo").value = "";
    document.getElementById("note").value = "";

    alert("Ordine inserito in Produzione.");
    refreshActiveTable();
  };

  // ---------------------------
  // Active table (Nuovo ordine)
  // ---------------------------
  window.refreshActiveTable = function refreshActiveTable() {
    const tbody = document.getElementById("activeTbody");
    if (!tbody) return;

    const orders = loadOrders();

    // "Ordini attivi" = non completati + completati nelle ultime 24 ore
    const list = orders.filter(o => o.status !== "Completato" || withinHours(o.updatedAt || o.createdAt, 24));

    tbody.innerHTML = "";

    if (!list.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="muted">Nessun ordine.</td>`;
      tbody.appendChild(tr);
      return;
    }

    for (const o of list) {
      const tr = document.createElement("tr");
      const pillClass =
        o.status === "Completato" ? "ok" :
        o.status === "Assemblaggio" ? "info" :
        o.status === "Controllo Qualità" ? "warn" : "";

      tr.innerHTML = `
        <td><b>${escapeHtml(o.articolo)}</b></td>
        <td>${escapeHtml(o.cliente)}</td>
        <td>${escapeHtml(o.sito)}</td>
        <td>${euro(o.prezzo)}</td>
        <td><span class="pill ${pillClass}">${escapeHtml(o.status)}</span></td>
        <td>${formatDateTime(o.createdAt)}</td>
        <td>${formatDateTime(o.updatedAt || o.createdAt)}</td>
      `;
      tbody.appendChild(tr);
    }
  };

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // ---------------------------
  // Board Produzione
  // ---------------------------
  function canMoveToAssemblaggio(order) {
    return !!order.frontOk && !!order.backOk;
  }

  function nextStatus(current) {
    const i = STATUSES.indexOf(current);
    if (i === -1) return current;
    return STATUSES[Math.min(i + 1, STATUSES.length - 1)];
  }

  function prevStatus(current) {
    const i = STATUSES.indexOf(current);
    if (i === -1) return current;
    return STATUSES[Math.max(i - 1, 0)];
  }

  function renderBoard() {
    const board = document.getElementById("board");
    if (!board) return;

    const orders = loadOrders().filter(o => o.status !== "Completato"); // in produzione solo non completati

    // group
    const byStatus = Object.fromEntries(STATUSES.map(s => [s, []]));
    for (const o of orders) {
      if (!byStatus[o.status]) byStatus[o.status] = [];
      byStatus[o.status].push(o);
    }

    board.innerHTML = "";

    for (const st of STATUSES) {
      if (st === "Completato") continue;

      const col = document.createElement("div");
      col.className = "col";
      const items = byStatus[st] || [];

      col.innerHTML = `
        <h2>
          <span>${st}</span>
          <span class="count">${items.length}</span>
        </h2>
        <div id="col-${cssSafe(st)}"></div>
      `;
      board.appendChild(col);

      const holder = col.querySelector(`#col-${cssSafe(st)}`);

      if (!items.length) {
        holder.innerHTML = `<div class="muted">Vuoto</div>`;
        continue;
      }

      for (const o of items.sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0))) {
        const card = document.createElement("div");
        card.className = "card";

        const warnAsm = (st === "Controllo Qualità" && !canMoveToAssemblaggio(o))
          ? `<div class="muted">Per andare in <b>Assemblaggio</b>: serve <b>Frontale OK</b> + <b>Posteriore OK</b>.</div>`
          : "";

        const frontBadge = o.frontOk ? `<span class="pill ok">Frontale OK</span>` : `<span class="pill warn">Frontale NO</span>`;
        const backBadge  = o.backOk  ? `<span class="pill ok">Posteriore OK</span>` : `<span class="pill warn">Posteriore NO</span>`;

        card.innerHTML = `
          <div class="title">${escapeHtml(o.articolo)} <span class="muted">• ${escapeHtml(o.sito)}</span></div>
          <div class="meta">
            <div><b>Cliente:</b> ${escapeHtml(o.cliente)}</div>
            <div><b>Prezzo:</b> ${euro(o.prezzo)} ${o.note ? `• <b>Note:</b> ${escapeHtml(o.note)}` : ""}</div>
            <div><b>Creato:</b> ${formatDateTime(o.createdAt)} • <b>Agg:</b> ${formatDateTime(o.updatedAt||o.createdAt)}</div>
            <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">${frontBadge}${backBadge}</div>
          </div>
          <div class="actions" style="margin-top:10px">
            <button class="small" data-act="front">${o.frontOk ? "Frontale: OK" : "Frontale: segna OK"}</button>
            <button class="small" data-act="back">${o.backOk ? "Posteriore: OK" : "Posteriore: segna OK"}</button>
            <button class="small" data-act="prev">← Indietro</button>
            <button class="small ok" data-act="next">Avanti →</button>
            <button class="small danger" data-act="del">Elimina</button>
            <button class="small done" data-act="done">Completato ✅</button>
          </div>
          <div style="margin-top:8px">${warnAsm}</div>
        `;

        // actions
        const btnFront = card.querySelector(`[data-act="front"]`);
        const btnBack  = card.querySelector(`[data-act="back"]`);
        const btnPrev  = card.querySelector(`[data-act="prev"]`);
        const btnNext  = card.querySelector(`[data-act="next"]`);
        const btnDel   = card.querySelector(`[data-act="del"]`);
        const btnDone  = card.querySelector(`[data-act="done"]`);

        btnFront.onclick = () => updateOrder(o.id, { frontOk: true });
        btnBack.onclick  = () => updateOrder(o.id, { backOk: true });

        btnPrev.onclick = () => {
          const target = prevStatus(o.status);
          updateOrder(o.id, { status: target });
        };

        btnNext.onclick = () => {
          let target = nextStatus(o.status);

          // regola: in Assemblaggio SOLO con frontOk+backOk
          if (target === "Assemblaggio" && !canMoveToAssemblaggio(o)) {
            alert("Non puoi spostare in Assemblaggio: servono Frontale OK + Posteriore OK.");
            return;
          }
          updateOrder(o.id, { status: target });
        };

        btnDone.onclick = () => {
          if (!confirm("Segnare come COMPLETATO? Andrà nelle Vendite.")) return;
          updateOrder(o.id, { status: "Completato" });
        };

        btnDel.onclick = () => {
          if (!confirm("Eliminare definitivamente questo ordine?")) return;
          const orders = loadOrders().filter(x => x.id !== o.id);
          saveOrders(orders);
          rerenderAll();
        };

        holder.appendChild(card);
      }
    }
  }

  function cssSafe(s) {
    return s.toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9\-]/g, "");
  }

  // ---------------------------
  // Vendite (protetta)
  // ---------------------------
  window.refreshSales = function refreshSales() {
    const wrap = document.getElementById("salesWrap");
    if (!wrap) return;

    const orders = loadOrders()
      .filter(o => o.status === "Completato")
      .filter(o => withinDays(o.updatedAt || o.createdAt, 365));

    // group by day
    const map = new Map();
    for (const o of orders) {
      const day = formatDate(o.updatedAt || o.createdAt);
      if (!map.has(day)) map.set(day, []);
      map.get(day).push(o);
    }

    const days = Array.from(map.keys()).sort((a,b) => (a < b ? 1 : -1)); // desc

    if (!days.length) {
      wrap.innerHTML = `<div class="muted">Nessuna vendita completata negli ultimi 365 giorni.</div>`;
      return;
    }

    let html = "";
    for (const day of days) {
      const items = map.get(day).sort((a,b) => (b.updatedAt||0)-(a.updatedAt||0));
      const total = items.reduce((s,o) => s + Number(o.prezzo||0), 0);

      html += `
        <div class="panel" style="margin-bottom:10px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <b>${day}</b>
            <span class="pill ok">Totale: ${euro(total)}</span>
          </div>
          <table>
            <thead>
              <tr>
                <th>Articolo</th><th>Cliente</th><th>Sito</th><th>€</th><th>Completato</th>
              </tr>
            </thead>
            <tbody>
              ${items.map(o => `
                <tr>
                  <td><b>${escapeHtml(o.articolo)}</b></td>
                  <td>${escapeHtml(o.cliente)}</td>
                  <td>${escapeHtml(o.sito)}</td>
                  <td>${euro(o.prezzo)}</td>
                  <td>${formatDateTime(o.updatedAt||o.createdAt)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    wrap.innerHTML = html;
  };

  // ---------------------------
  // Export CSV (Excel)
  // ---------------------------
  function getCompletedOrders() {
    return loadOrders()
      .filter(o => o.status === "Completato")
      .filter(o => withinDays(o.updatedAt || o.createdAt, 365));
  }

  window.downloadSalesDaily = function downloadSalesDaily() {
    // esporta solo il giorno corrente
    const today = formatDate(now());
    const items = getCompletedOrders().filter(o => formatDate(o.updatedAt || o.createdAt) === today);

    if (!items.length) {
      alert("Nessuna vendita completata oggi.");
      return;
    }

    const header = ["Giorno", "Articolo", "Cliente", "Sito", "Prezzo", "Creato", "Completato", "Note"];
    const rows = items.map(o => [
      today,
      o.articolo,
      o.cliente,
      o.sito,
      o.prezzo,
      formatDateTime(o.createdAt),
      formatDateTime(o.updatedAt || o.createdAt),
      o.note || "",
    ]);

    const csv = [header, ...rows].map(r => r.map(sanitizeCsv).join(",")).join("\n");
    downloadTextFile(`vendite_${today}.csv`, csv, "text/csv;charset=utf-8");
  };

  window.downloadSalesMonthly = function downloadSalesMonthly() {
    // esporta mese corrente
    const d = new Date();
    const ym = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;

    const items = getCompletedOrders().filter(o => {
      const day = formatDate(o.updatedAt || o.createdAt);
      return day.startsWith(ym);
    });

    if (!items.length) {
      alert("Nessuna vendita completata in questo mese.");
      return;
    }

    const header = ["Giorno", "Articolo", "Cliente", "Sito", "Prezzo", "Creato", "Completato", "Note"];
    const rows = items.map(o => [
      formatDate(o.updatedAt || o.createdAt),
      o.articolo,
      o.cliente,
      o.sito,
      o.prezzo,
      formatDateTime(o.createdAt),
      formatDateTime(o.updatedAt || o.createdAt),
      o.note || "",
    ]);

    const csv = [header, ...rows].map(r => r.map(sanitizeCsv).join(",")).join("\n");
    downloadTextFile(`vendite_${ym}.csv`, csv, "text/csv;charset=utf-8");
  };

  // ---------------------------
  // Render all
  // ---------------------------
  function rerenderAll() {
    // se sei su new -> tabella
    const isNewVisible = !document.getElementById("page-new").classList.contains("hide");
    const isPrepVisible = !document.getElementById("page-prep").classList.contains("hide");
    const isSalesVisible = !document.getElementById("page-sales").classList.contains("hide");

    if (isNewVisible) refreshActiveTable();
    if (isPrepVisible) renderBoard();
    if (isSalesVisible) refreshSales();
  }

  // ---------------------------
  // Auto-clean: completati >24h spariscono (solo completati)
  // ---------------------------
  function cleanupCompletedOlderThan24h() {
    const orders = loadOrders();
    const cleaned = orders.filter(o => {
      if (o.status !== "Completato") return true;
      const ts = o.updatedAt || o.createdAt;
      return withinHours(ts, 24);
    });
    if (cleaned.length !== orders.length) saveOrders(cleaned);
  }

  // ---------------------------
  // Init
  // ---------------------------
  function init() {
    cleanupCompletedOlderThan24h();

    // default view: New
    setActive("new");
    showNew();

    // periodic cleanup
    setInterval(() => {
      cleanupCompletedOlderThan24h();
      rerenderAll();
    }, 60 * 1000);
  }

  document.addEventListener("DOMContentLoaded", init);
})();
